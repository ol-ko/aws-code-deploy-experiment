AWSTemplateFormatVersion: 2010-09-09
Description: search notification infrastructure resources
Resources:
  LambdaALatestVersionErrorMetricGreaterThanZeroAlarm:
    Properties:
      AlarmDescription: Lambda Function Error > 0
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
      - Name: Resource
        Value:
          Fn::Join:
          - ':'
          - - Ref: LambdaFunctionA
            - Fn::Select:
              - '7'
              - Fn::Split:
                - ':'
                - Ref: LambdaFunctionA.Version
      - Name: FunctionName
        Value:
          Ref: LambdaFunctionA
      EvaluationPeriods: 1
      MetricName: Errors
      Namespace: AWS/Lambda
      Period: 60
      Statistic: Sum
      Threshold: 0
    Type: AWS::CloudWatch::Alarm
  LambdaBLatestVersionErrorMetricGreaterThanZeroAlarm:
    Properties:
      AlarmDescription: Lambda Function Error > 0
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
      - Name: Resource
        Value:
          Fn::Join:
          - ':'
          - - Ref: LambdaFunctionB
            - Fn::Select:
              - '7'
              - Fn::Split:
                - ':'
                - Ref: LambdaFunctionB.Version
      - Name: FunctionName
        Value:
          Ref: LambdaFunctionB
      EvaluationPeriods: 1
      MetricName: Errors
      Namespace: AWS/Lambda
      Period: 60
      Statistic: Sum
      Threshold: 0
    Type: AWS::CloudWatch::Alarm
  LambdaFunctionA:
    Properties:
      AutoPublishAlias: live
      CodeUri: s3://hg-test-sandbox/olga/aws-sandbox/441b362bf64012a29040254b804ef6e8
      DeploymentPreference:
        Alarms:
        - Ref: LambdaALatestVersionErrorMetricGreaterThanZeroAlarm
        Hooks:
          PreTraffic:
            Ref: PreTrafficLambdaFunction
        Type: Linear10PercentEvery2Minutes
      Environment:
        Variables:
          QUEUE_URL:
            Ref: QueueBetweenAAndB
      FunctionName: LambdaA
      Handler: index.handler
      Policies:
      - Statement:
        - Action:
          - sqs:SendMessage
          Effect: Allow
          Resource: '*'
        Version: '2012-10-17'
      Runtime: nodejs8.10
      Timeout: 15
    Type: AWS::Serverless::Function
  LambdaFunctionB:
    Properties:
      AutoPublishAlias: live
      CodeUri: s3://hg-test-sandbox/olga/aws-sandbox/9a844bb2b9f6a2437ef5e340e21efab0
      DeploymentPreference:
        Alarms:
        - Ref: LambdaBLatestVersionErrorMetricGreaterThanZeroAlarm
        Type: Linear10PercentEvery2Minutes
      Events:
        SQSEvent:
          Properties:
            BatchSize: 1
            Queue:
              Fn::GetAtt:
              - QueueBetweenAAndB
              - Arn
          Type: SQS
      FunctionName: LambdaB
      Handler: index.handler
      Runtime: nodejs8.10
      Timeout: 15
    Type: AWS::Serverless::Function
  PreTrafficLambdaFunction:
    Properties:
      CodeUri: s3://hg-test-sandbox/olga/aws-sandbox/3c1a19b67967db5277679cbb8e8d4199
      DeploymentPreference:
        Enabled: false
      Environment:
        Variables:
          FUNCTION_NAME: LambdaA
          FUNCTION_VERSION:
            Fn::Select:
            - '7'
            - Fn::Split:
              - ':'
              - Ref: LambdaFunctionA.Version
      FunctionName: CodeDeployHook_preTrafficHook
      Handler: index.handler
      Policies:
      - Statement:
        - Action:
          - codedeploy:PutLifecycleEventHookExecutionStatus
          Effect: Allow
          Resource:
            Fn::Sub: arn:aws:codedeploy:${AWS::Region}:${AWS::AccountId}:deploymentgroup:${ServerlessDeploymentApplication}/*
        Version: '2012-10-17'
      - Statement:
        - Action:
          - lambda:InvokeFunction
          Effect: Allow
          Resource:
            Fn::GetAtt:
            - LambdaFunctionA
            - Arn
        Version: '2012-10-17'
      Runtime: nodejs8.10
    Type: AWS::Serverless::Function
  QueueBetweenAAndB:
    Properties:
      DelaySeconds: 20
    Type: AWS::SQS::Queue
Transform: AWS::Serverless-2016-10-31
